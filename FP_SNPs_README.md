# Задание 3 (Python)

## Данные

Все данные лежат в папке `data`:

- `FP_SNPs.txt` -- исходный файл;
- `FP_SNPs_10k_GB38_twoAllelsFormat.tsv` -- предобработанный файл;
- `result_file.tsv` -- выходной файл;
- `pipeline.log` -- лог-файл.

## Предобработка

Для предобработки файла GRAF используется скрипт
`preprocessing_script.sh` (находится в папке `src`). Он состоит из
двух команд (помимо обработки аргументов командной строки):
1. `echo -e "#CHROM\tPOS\tID\tALLELE1\tALLELE2"` -- выводит в поток
   вывода неполный заголовок VCF-файла, согласно
   [спецификации](https://samtools.github.io/hts-specs/VCFv4.2.pdf)
2. Вторая команда отвечает за конвертацию файла с помощью утилиты
   `awk`

   ```
   awk '{if (NR>1 && $2 != 23) \
     printf "chr%d\t%d\trs%d\t%s\t%s\n",$2,$4,$1,$5,$6}'\
     $INPUT_FILE
   ```
   
   Она выводит столбцы в порядке VCF-формата и добавляет префиксы
   `chr` в первый и `rs` в третий столбцы. Также, она фильтрует
   строки, опуская первую (заголовок) и те строки, в которых номер
   хромосомы равен 23 (номер X-хромосомы).

##  Описание работы скрипта

Для преобразования данных реализован скрипт `src/main.py`. 
В нем используется библиотека `pysam` для обращения к референсному 
файлу. 

Скрипт проходит по обработанному файлу GRAF и проверяет, какой из двух
нуклеотидов находится в на данной позиции в референсном геноме.  В
случае, если ни один из них не подошел, пропускает и пишет
предупреждение в лог.

Использование:
```
python3 main.py [-h] -i INPUT_FILE [-o OUTPUT_FILE] [-l LOG_FILE] -r REFERENCE [--index-file INDEX_FILE]
```

### Аргументы командной строки

- `-h`/`--help` -- выводит на экран вспомогательное сообщение;
- `-i`/`--input-file` -- входной файл GRAF, предобработанный скриптом
  выше;
- `-o`/`--output-file` -- выходной файл, по умолчанию результат пишется 
  в поток вывода;
- `-l`/`--log-file` -- лог-файл, по умолчанию логи выводятся в поток 
  ошибок;
- `-r`/`--reference` -- файл референса;
- `--index-file` -- индекс референса, по умолчанию равен референс-файлу
  с суффиксом `.fai`.

## Связка с docker

Для демонстрации работы написаны скрипты `entrypoint.sh` (лежит в
директории `src`) и `pipeline.sh`.

Первый представляет собой команду по умолчанию в докер-контейнере, 
которая:

1. Предобрабатывает файл `FP_SNPs.txt`;
2. Индексирует референс, если индекса нет;
3. Запускает скрипт с необходимыми параметрами.

Вторая представляет собой пайплайн работы. Использование:
```console
foo@bar:~$ ./pipeline.sh -e [ENTRYPOINT] -d [DOCKER IMAGE NAME] -v [DATA FOLDER]
```

Скрипт собирает образ и запускает контейнер.

Аргументы:
1.  `ENTRYPOINT` -- вход в программу. По умолчанию не задан и докер
    запускает `bash`. Можно задать `run` и тогда при запуске
    выполнится скрипт;
2.  `DOCKER IMAGE NAME` -- имя докер-образа. По умолчанию `biodocker`;
3. `DATA FOLDER` -- папка, которая монтируется внутрь контейнера по
   пути `/ref/GRCh38.d1.vd1_mainChr/sepChrs/`.  По умолчанию
   `$PWD/data/`. **Важно**: путь должен быть абсолютный и
   заканчиваться на `/`.
